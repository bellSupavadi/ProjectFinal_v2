<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="leafletroutingmachine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" data-require="leaflet@0.7.3" data-semver="0.7.3"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
 
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <!-- Popper JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <title>shop</title>
  <script src="script.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="check.css">
  <script src="ejs.js"></script>
</head> 
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-app.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-storage.js"></script>
  <script>
        // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyDoHO89lanbk1_OqG9oBPSRYkYhc5OpHlw",
    authDomain: "testproject-f89be.firebaseapp.com",
    databaseURL: "https://testproject-f89be.firebaseio.com",
    projectId: "testproject-f89be",
    storageBucket: "testproject-f89be.appspot.com",
    messagingSenderId: "282046642874",
    appId: "1:282046642874:web:c4de5e6851594a6b"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
  var storage = firebase.storage();


    </script>
<body>
  <style>
  #mapid { height: 300px; }</style>
  <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <a class="navbar-brand" href="index.html">
          <img src="photo/MFR.png" style="width:50px;">
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
        aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav ml-auto">
           
              <li class="nav-item">
                  <a class="nav-link" href="shop.html">RENT</a>
                </li>
                
          <li class="nav-item">
            <a class="nav-link" href="about.html">ABOUT</a>
          </li>
          
          <li class="nav-item">
              <a class="btn btn-outline-success my-2 my-sm-0" href="shopowner.html">SHOP</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" onclick="logout()">LOGOUT</a>
          </li>
        </ul>
      </div>
  </nav>
  
  </div>
  
 <br><br><br>
<div class="container">
  <div class="row">
    <h1>ลงทะเบียนร้าน</h1>
  </div>
  <hr>
  <br>
    <div class="form-group">
        <div class="row">
            <div class="col-sm-6">
      <label for="">ชื่อร้าน</label>
      <input type="text"
        class="form-control" name="" id="shopname" aria-describedby="helpId" placeholder="">
     </div>
     <div class="col-sm-6">
             <label for="">ชื่อ-สกุล</label>
             <input type="text"
               class="form-control" name="" id="name" aria-describedby="helpId" placeholder="">
            </div>
     </div>
    </div>
    
    <div class="form-group">
         <div class="row">
             <div class="col-sm-6">
                 <label for="">เบอร์โทรติดต่อ</label>
                 <input type="text"
                   class="form-control" name="" id="phone" aria-describedby="helpId" placeholder="">
                </div>
      
      <div class="col-sm-6">
              <label for="">Email</label>
              <input type="email"
                class="form-control" name="" id="mail" aria-describedby="helpId" placeholder="">
             </div>
      </div>
     </div>
    
     
     <div class="form-group">
        <label for="">ที่อยู่</label>
        <textarea class="form-control" rows="5" id="address" ></textarea>
      </div>
     <hr>
     <h3>เอกสาร</h3>
     <span>กรุณาอัพโหลดเอกสารที่ถูกต้องทราบในการเช่ารถจักรยานยนต์</span>
     
     <div class="form-group">
        <label for="">1.เอกสารที่ต้องใช้สำหรับเช่ารถจักรยานยนต์</label>
        <textarea class="form-control" rows="5"id="doc" ></textarea>
      </div>
      <br>
      <label for="">2.สัญญาการเช่ารถ</label>
      
      <form class="md-form">
        
        <div class="file-field">
          
            <!-- <span>Choose file</span> -->
            <!-- <input  class="btn btn-primary float-left"type="file" id="files" name="files[]"> -->
          
          <div class="file-path-wrapper">
            <input class="file-path validate" type="file" id="files" name="files[]" placeholder="Upload your file">
          </div>
        </div> 
      
      </form>
      <br><br>
        <div id="mapid"></div>
<br>
     <center><a onclick="previewFile()" class="btn btn-outline-success" >บันทึก</a></center> 
     
     
    </div> 
    <!-- <section id="credit">
        <p>Motorcycle For Rent</p>   
    </section> -->
     <!-- Modal -->
 <div class="modal fade" id="elegantModalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
 aria-hidden="true">
 <div class="modal-dialog" role="document">
   <!--Content-->
   <div class="modal-content form-elegant">
     <!--Header-->
     <div class="modal-header text-center">
     <p>ลงทะเบียนร้านเรียบร้อย</p>
       <button type="button" class="close" data-dismiss="modal" aria-label="Close">
         <span aria-hidden="true">&times;</span>
       </button>
       
     </div>
     <!--Body-->
     <div class="modal-body mx-4">
       <!--Body-->
       <div class="checkmark">
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 161.2 161.2" enable-background="new 0 0 161.2 161.2" xml:space="preserve">
      <path class="path" fill="none" stroke="#73AF55" stroke-miterlimit="10" d="M425.9,52.1L425.9,52.1c-2.2-2.6-6-2.6-8.3-0.1l-42.7,46.2l-14.3-16.4
          c-2.3-2.7-6.2-2.7-8.6-0.1c-1.9,2.1-2,5.6-0.1,7.7l17.6,20.3c0.2,0.3,0.4,0.6,0.6,0.9c1.8,2,4.4,2.5,6.6,1.4c0.7-0.3,1.4-0.8,2-1.5
          c0.3-0.3,0.5-0.6,0.7-0.9l46.3-50.1C427.7,57.5,427.7,54.2,425.9,52.1z"/>
      <circle class="path" fill="none" stroke="#73AF55" stroke-width="4" stroke-miterlimit="10" cx="80.6" cy="80.6" r="62.1"/>
      <polyline class="path" fill="none" stroke="#73AF55" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="113,52.8 
          74.1,108.4 48.2,86.4 "/>
      
     
      
      </svg>
        <br>
      <a href="" class="btn btn-outline-success btn-block" data-toggle="modal" data-target="#elegantModalForm">ร้าน</a>
      </div>
   
 </div>
 </div>
  
  
  
 <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js" data-require="leaflet@0.7.3"
    data-semver="0.7.3"></script>
<script type="text/javascript" src="http://www.liedman.net/leaflet-realtime/dist/leaflet-realtime.js"></script>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
<script src="leafletroutingmachine.js"></script>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
 
 
 
</body>
<script>
  var email
  var uid
  firebase.auth().onAuthStateChanged(function (user) {
    if (user) {
      // User is signed in.
      email=  user.email
      uid=user.uid
      phoneandmail(user.uid)
      // ...
    } else {
      // User is signed out.
       window.location.href="index.html"
      // ...
    }
  });
function phoneandmail(uid) {
  db.collection("datatest").where("UID", "==", uid).get()
    .then(function (querySnapshot) {
      // doc.data() is never undefined for query doc snapshots
     console.log(querySnapshot.docs[0].data());
     querySnapshot.docs.forEach(function(data){
      document.getElementById("phone").value=data.data().phone;
    document.getElementById("mail").value=email;
    document.getElementById("name").value=data.data().name+' '+data.data().surname;
     });

    })
    .catch(function (error) {
      console.log("Error getting documents: ", error);
    });




}




var pic =''

//function to save file
function previewFile() {
  console.log(email);
  

  var file = document.getElementById("files").files[0];
  console.log(file);

  // Create a storage reference from our storage service
var storageRef = storage.ref();
  

  //dynamically set reference to the file name
  var thisRef = storageRef.child('license/'+file.name);
console.log(thisRef);

  //put request upload file to firebase storage
  thisRef.put(file).then(function (snapshot) {
    console.log('5555');
     //get request to get URL for uploaded file
  thisRef.getDownloadURL().then(function(url) {
      // Insert url into an <img> tag to "download"
      console.log(url);
      pic=url


      add(pic)

    }).catch(function(error) {
    
      // A full list of error codes is available at
      // https://firebase.google.com/docs/storage/web/handle-errors
      switch (error.code) {
        case 'storage/object-not-found':
          // File doesn't exist
          break;
    
        case 'storage/unauthorized':
          // User doesn't have permission to access the object
          break;
    
        case 'storage/canceled':
          // User canceled the upload
          break;
    
        
    
        case 'storage/unknown':
          // Unknown error occurred, inspect the server response
          break;
      }
    });
  });

 

}
function add(pic) {
    console.log(pic);
   var phone= document.getElementById("phone").value
   var mail= document.getElementById("mail").value
   var name= document.getElementById("name").value
   var shopname= document.getElementById("shopname").value
   var address= document.getElementById("address").value
   var doc= document.getElementById("doc").value
   console.log(latlng);
   
    db.collection("shop").add({
      UID:uid,
    shopname: shopname,
    name: name,
    email:mail,
    phone:phone,
    address:address,
    picshop:pic,
    doc:doc,
    UID:uid,
    lat:latlng.lat,
    lng:latlng.lng,
    status:false
})
.then(function(docRef) {
    console.log("Document written with ID: ", docRef.id);
    window.location.href="shopownerdetail.html"
})
.catch(function(error) {
    console.error("Error adding document: ", error);
});
    
}

var mymap = L.map('mapid').setView([51.505, -0.09], 13);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibGVra2xhIiwiYSI6ImNqd3Q3a2lqNzBnODMzeW1xdWVtbzJ5NG0ifQ.hlJDNJAqup1I9yMU03A0jQ', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoibGVra2xhIiwiYSI6ImNqd3Q3a2lqNzBnODMzeW1xdWVtbzJ5NG0ifQ.hlJDNJAqup1I9yMU03A0jQ'
    }).addTo(mymap);
    // var marker = L.marker([51.5, -0.09]).addTo(mymap);
    // var layer = L.marker([51.6, -0.09]).addTo(mymap);
    // layer.addTo(mymap);
    var t
    var t2
    var lat = {};
    var check = false;
    my_function()
    function my_function() {
        /// call your function here

        mymap.locate({setView: true, maxZoom: 20});
    };

   // setInterval(my_function, 1000);
    function onLocationFound(e) {
        var radius = e.accuracy;
        console.log(e.latlng);
        lat = e.latlng;
          L.marker(e.latlng).addTo(mymap)
                .bindPopup("You are within " + radius + " meters from this point").openPopup();
                mymap.setView(e.latlng,13);
        // if (t) { // check
        //     mymap.removeLayer(t);
        //     mymap.removeLayer(t2);
        // }
        // t2 = L.circle(e.latlng, radius).addTo(mymap);
        // t = L.circle(e.latlng, {
        //     color: 'white',
        //     fillColor: 'blue',
        //     className: 'blinking'
        // }).addTo(mymap)


        var myIcon = L.icon({
            iconUrl: 'leaf-green.png',
    shadowUrl: 'leaf-shadow.png',

    iconSize:     [38, 95], // size of the icon
    shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });


        if (check == false) {
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mymap);
            var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
})
            // L.Routing.control({
            //     lineOptions: {
            //         styles: [
            //             { color: ' #ececec', opacity: 0.9, weight: 9 },
            //             { color: ' rgb(113, 167, 253)', opacity: 1, weight: 3 }
            //         ]
            //     }, setView: true,addWaypoints: false,
            //     waypoints: [
            //         L.latLng(lat.lat, lat.lng),
            //         L.latLng(lat.lat + 0.001, lat.lng + 0.001)
            //     ], show: false, createMarker: function () {
            //         return L.marker([lat.lat + 0.001, lat.lng + 0.001], {
            //             icon: myIcon
            //         }).addTo(mymap);
            //     }
            // }).addTo(mymap);

            check = true;
        }
    }
    mymap.on('locationfound', onLocationFound);

    function onLocationError(e) {
        // alert(e.message);
    }

    mymap.on('locationerror', onLocationError);
    var mark
    var latlng
    mymap.on('click', function(e) {
      var myIcon = L.icon({
            iconUrl: 'leaf-green.png',
    shadowUrl: 'leaf-shadow.png',

    iconSize:     [38, 95], // size of the icon
    shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });
        
        console.log(e.latlng.lat);
        if (mark != undefined) {
          mymap.removeLayer(mark);
        };
      // mymap.removeLayer(mark);
// for (let i = 0; i < 5; i++) {
//   mark=L.marker([e.latlng.lat+i,e.latlng.lng+i], {icon: myIcon}).addTo(mymap);
  
// }

 mark=L.marker([e.latlng.lat,e.latlng.lng], {icon: myIcon}).addTo(mymap);


    alert(e.latlng);
    latlng=e.latlng
});

</script>
</html>